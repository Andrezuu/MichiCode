name: CI/CD MichiCode - Despliegue Dockerizado

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read 

env:
  DOCKER_USER: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-frontend
  EC2_HOST: ${{ secrets.EC2_HOST_IP }}
  EC2_USER: ubuntu
  REMOTE_DIR: /home/ubuntu/michicode-app

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout C贸digo Fuente
        uses: actions/checkout@v4

      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest
          build-args: |
            BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000

      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          build-args: |
            REACT_APP_API_BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000

  deploy:
    runs-on: ubuntu-latest
    needs: build-push

    steps:
      - name: Checkout repo para copiar archivos
        uses: actions/checkout@v4

      - name: Configurar e Instalar Docker en EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo apt update
            sudo apt install -y docker.io docker-compose
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker ubuntu
            mkdir -p ${{ env.REMOTE_DIR }}

      - name: Subir archivos de configuraci贸n a EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.prod.yml, frontend/nginx.conf, monitoring/prometheus/prometheus.yml"
          target: "${{ env.REMOTE_DIR }}"

      - name: Ejecutar Despliegue con Comandos de Limpieza y Ejecuci贸n
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Detener y eliminar contenedores espec铆ficos (Tus comandos solicitados)
            docker stop frontend backend michicode-mongo || true
            docker rm frontend backend michicode-mongo || true
            
            # 2. Limpieza de sistema (Tus comandos solicitados) [cite: 1453]
            docker container prune -f
            docker image prune -f
            
            # 3. Crear red si no existe (Necesario para tus comandos --network)
            docker network create michicode-net || true
            
            # 4. Ejecuci贸n de contenedores con tus par谩metros exactos
            # MongoDB
            docker run -d \
              --name michicode-mongo \
              --network michicode-net \
              -p 27017:27017 \
              -e MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_INITDB_ROOT_USERNAME }} \
              -e MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_INITDB_ROOT_PASSWORD }} \
              -e MONGO_INITDB_DATABASE=${{ secrets.MONGO_INITDB_DATABASE }} \
              mongo:6
            
            # Backend
            docker run -d \
              --name backend \
              --network michicode-net \
              -p 5000:5000 \
              -e PORT=5000 \
              -e MONGODB_URI="mongodb://${{ secrets.MONGO_INITDB_ROOT_USERNAME }}:${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}@michicode-mongo:27017/michicode?authSource=admin" \
              -e BASE_URL="http://${{ env.EC2_HOST }}:5000" \
              ${{ env.DOCKER_IMAGE_BACKEND }}:latest
            
            # Frontend
            docker run -d \
              --name frontend \
              --network michicode-net \
              -p 80:80 \
              ${{ env.DOCKER_IMAGE_FRONTEND }}:latest

            # 5. Levantar Monitoreo
            cd ${{ env.REMOTE_DIR }}
            docker-compose -f docker-compose.prod.yml up -d prometheus grafana node-exporter

      - name: Notificar a Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
            "content": " **Despliegue Finalizado**\n**SHA:** `${{ github.sha }}`\n**Estado:** Exitoso\n**URL App:** http://${{ secrets.EC2_HOST_IP }}\n**URL Grafana:** http://${{ secrets.EC2_HOST_IP }}:3000"
          }' ${{ secrets.DISCORD_WEBHOOK }}