name: CI/CD MichiCode - Despliegue Dockerizado

on:
  push:
    branches: [ main ]
  # Opcional: Permite ejecutar el workflow manualmente
  workflow_dispatch:

# Definimos variables de entorno generales (puedes cambiar 'user/repo')
env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-frontend
  EC2_HOST: ${{ secrets.EC2_HOST_IP }}
  EC2_USER: ec2-user # o ubuntu, dependiendo de tu AMI

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      # --- 1. Login a Docker Hub (o Registry de tu elección) ---
      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      
      # --- 2. Build de Imágenes Docker ---
      # [cite_start]Requisito: Las imágenes deben construirse dentro del pipeline [cite: 35, 37]
      - name: Build Imagen Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:${{ github.sha }}, ${{ env.DOCKER_IMAGE_BACKEND }}:latest
          # Se pasa la URL de producción (EC2_HOST) como variable de entorno
          build-args: |
            BASE_URL=${{ secrets.EC2_HOST_DNS }}
      
      - name: Build Imagen Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ github.sha }}, ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          # El frontend debe saber a dónde llamar a la API
          build-args: |
            REACT_APP_API_BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000

      # --- 3. Despliegue a EC2 ---
      # [cite_start]Requisito: Desplegar en EC2 usando un pipeline y secretos [cite: 13, 14, 39, 40]
      - name: Despliegue vía SSH a EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          # Usar una clave SSH almacenada en GitHub Secrets
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # El despliegue a una EC2 requiere:
          # 1. Copiar el docker-compose.yml (o tenerlo ya)
          # 2. Ejecutar docker pull para obtener las imágenes nuevas
          # 3. Ejecutar docker-compose up -d
          script: |
            # Crear directorio de trabajo si no existe
            mkdir -p ~/michicode-app
            cd ~/michicode-app
            
            # Copiar docker-compose.yml de la carpeta .github/ al servidor,
            # o copiarlo de tu repo si ya lo tienes en el servidor.
            # Aquí asumo que lo copiamos del repo (necesitarás el archivo en el repo)
            
            # Detener contenedores viejos y borrar imágenes antiguas
            docker-compose down || true
            
            # Comando para hacer pull de las nuevas imágenes
            docker pull ${{ env.DOCKER_IMAGE_BACKEND }}:${{ github.sha }}
            docker pull ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ github.sha }}
            
            # Levantamos los nuevos contenedores (usando el tag específico del commit)
            # Requerirá un docker-compose.prod.yml que use estos tags y variables de entorno
            
            # Esto es un ejemplo simplificado; la versión final requerirá
            # que el docker-compose.prod.yml esté presente en EC2.
            
            # EJEMPLO SIMPLIFICADO: Copiando docker-compose (asume que está en la raíz)
            # Asegúrate de que este archivo ya tiene las referencias a las imágenes
            # con el TAG: latest o github.sha y las variables de entorno de producción.
            
            # docker-compose -f docker-compose.prod.yml up -d
            
            echo "Despliegue de imágenes ${{ github.sha }} completado en EC2."