name: CI/CD MichiCode - Despliegue Dockerizado

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-frontend
  EC2_HOST: ${{ secrets.EC2_HOST_IP }}
  EC2_USER: ubuntu
  REMOTE_DIR: /home/ubuntu/michicode-app

jobs:

  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c칩digo
        uses: actions/checkout@v4

      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build y Push Imagen Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest
          build-args: |
            BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000

      - name: Build y Push Imagen Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          build-args: |
            REACT_APP_API_BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000

  deploy:
    runs-on: ubuntu-latest
    needs: build-push

    steps:
      - name: Checkout del c칩digo
        uses: actions/checkout@v4

      # 1. Crear directorio remoto si no existe
      - name: Crear directorio remoto en EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p ${{ env.REMOTE_DIR }}

      # 2. Copiar archivos correctamente
      - name: Copiar docker-compose.prod.yml y database/
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          target: ${{ env.REMOTE_DIR }}
          source: |
            docker-compose.prod.yml
            database/**

      # 3. Ejecutar despliegue en EC2
      - name: Ejecutar Docker Compose en EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ env.REMOTE_DIR }}

            echo "Deteniendo contenedores previos..."
            docker compose down || true

            echo "Actualizando im치genes desde Docker Hub..."
            docker pull ${{ env.DOCKER_IMAGE_BACKEND }}:latest
            docker pull ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
            docker pull mongo:6

            echo "Iniciando despliegue con docker-compose.prod.yml..."
            DOCKER_HUB_USERNAME="${{ secrets.DOCKER_HUB_USERNAME }}" \
            EC2_HOST_DNS="${{ secrets.EC2_HOST_DNS }}" \
            docker compose --file docker-compose.prod.yml up -d

            echo "Contenedores corriendo:"
            docker ps

            echo "Despliegue completado. Aplicaci칩n disponible en:"
            echo "http://${{ secrets.EC2_HOST_DNS }}"