name: CI/CD MichiCode - Despliegue Dockerizado

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-frontend
  EC2_HOST: ${{ secrets.EC2_HOST_IP }}
  EC2_USER: ubuntu
  REMOTE_DIR: /home/ubuntu/michicode-app

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest
          build-args: |
            BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          build-args: |
            REACT_APP_API_BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000

  deploy:
    runs-on: ubuntu-latest
    needs: build-push

    steps:
      - name: Checkout repo para copiar archivos
        uses: actions/checkout@v4

      - name: CLEAN EC2 antes del despliegue
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üßπ Limpiando carpeta previa..."
            mkdir -p ${{ env.REMOTE_DIR }}
            rm -rf  ${{ env.REMOTE_DIR }}/*

            echo "üóÇÔ∏è Contenido despu√©s de limpiar:"
            ls -la ${{ env.REMOTE_DIR }}

      - name: Subir archivos necesarios a EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./docker-compose.prod.yml, ./database/"
          target: "${{ env.REMOTE_DIR }}"
          command_timeout: 200s

      - name: Ejecutar Docker Compose en EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ env.REMOTE_DIR }}

            echo "Deteniendo contenedores previos..."
            docker compose down || true

            echo "Actualizando im√°genes..."
            docker pull mongo:6
            docker pull ${{ env.DOCKER_IMAGE_BACKEND }}:latest
            docker pull ${{ env.DOCKER_IMAGE_FRONTEND }}:latest

            echo "Arrancando stack..."
            docker compose --file docker-compose.prod.yml up -d

            echo "Contenedores activos:"
            docker ps -a

            echo "‚úî Despliegue completado. URL:"
            echo "http://${{ secrets.EC2_HOST_DNS }}"