name: CI/CD MichiCode - Despliegue Dockerizado

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Definimos variables de entorno generales
env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-frontend
  EC2_HOST: ${{ secrets.EC2_HOST_IP }}
  # Usuario correcto para la AMI Ubuntu. Esto corrige el fallo de autenticación.
  EC2_USER: ubuntu 
  REMOTE_DIR: /home/ubuntu/michicode-app # Directorio de destino fijo

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      # [cite_start]--- 1. Login a Docker Hub (Requisito: Gestión de secretos) [cite: 40] ---
      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      
      # [cite_start]--- 2. Build y Push de Imágenes Docker (Requisito: Contenerización en Pipeline) [cite: 35, 37] ---
      - name: Build y Push Imagen Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest
          build-args: |
            BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000
      
      - name: Build y Push Imagen Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          build-args: |
            REACT_APP_API_BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000
            
  deploy:
    runs-on: ubuntu-latest
    needs: build-push
    
    steps:
      - name: Checkout del código (Necesario para copiar archivos de orquestación)
        uses: actions/checkout@v4
        
      # --- 3A. Sincronizar Archivos (Solución al Directorio Vacío) ---
      # Usamos scp-action para garantizar que los archivos lleguen a la EC2.
      - name: Copiar archivos de Orquestación y DB a EC2
        uses: appleboy/scp-action@v0.1.7 
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Crea el directorio si no existe y copia: docker-compose.prod.yml y la carpeta database
          source: "docker-compose.prod.yml, database"
          target: "${{ env.REMOTE_DIR }}"
          # Aseguramos que el directorio de destino exista antes de la copia
          command_timeout: 100s
          
      # --- 3B. [cite_start]Ejecutar Docker Compose UP (Requisito: Despliegue en EC2) [cite: 13, 39] ---
      - name: Ejecutar Docker Compose UP en EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Moverse al directorio donde se copió el archivo
            cd ${{ env.REMOTE_DIR }}
            
            # --- EJECUCIÓN DEL DESPLIEGUE ---
            
            # 1. Detener e intentar limpiar contenedores viejos
            docker compose down --remove-orphans || true
            docker pull mongo:6 # Asegurar que la imagen base de la DB está lista
            
            # 2. Comando para hacer pull de las nuevas imágenes (usando el tag 'latest')
            docker pull ${{ env.DOCKER_IMAGE_BACKEND }}:latest
            docker pull ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
            
            # 3. Levantamos los contenedores con las variables de entorno de producción
            echo "Ejecutando Docker Compose UP..."
            
            # Capturamos los secretos necesarios para inyectarlos en el shell
            DOCKER_HUB_USERNAME="${{ secrets.DOCKER_HUB_USERNAME }}"
            EC2_HOST_DNS="${{ secrets.EC2_HOST_DNS }}"
            
            # [cite_start]Ejecución del comando de orquestación [cite: 13, 39]
            DOCKER_HUB_USERNAME=$DOCKER_HUB_USERNAME \
            EC2_HOST_DNS=$EC2_HOST_DNS \
            docker compose -f docker-compose.prod.yml up -d
            
            echo "Verificación final de contenedores:"
            docker ps
            echo "¡DESPLIEGUE AUTOMÁTICO COMPLETO! La aplicación debe estar disponible en http://${EC2_HOST_DNS}"