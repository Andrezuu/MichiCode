name: CI/CD MichiCode - Despliegue Dockerizado

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Definimos variables de entorno generales
env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-backend
  DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_HUB_USERNAME }}/michicode-frontend
  EC2_HOST: ${{ secrets.EC2_HOST_IP }}
  # ¡CORREGIDO! El usuario de la AMI Ubuntu es 'ubuntu'
  EC2_USER: ubuntu 

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      # [cite_start]--- 1. Login a Docker Hub (Requisito: Gestión de secretos) [cite: 40] ---
      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      
      # [cite_start]--- 2. Build y Push de Imágenes Docker (Requisito: Contenerización en Pipeline) [cite: 35, 37] ---
      - name: Build y Push Imagen Backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_BACKEND }}:latest
          build-args: |
            BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000
      
      - name: Build y Push Imagen Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          build-args: |
            REACT_APP_API_BASE_URL=http://${{ secrets.EC2_HOST_DNS }}:5000
            
  deploy:
    runs-on: ubuntu-latest
    needs: build-push # Espera a que las imágenes se construyan y suban
    
    steps:
      - name: Checkout del código (Necesario para copiar archivos de orquestación)
        uses: actions/checkout@v4
        
      # [cite_start]--- 3. Despliegue a EC2 (Requisito: Despliegue en EC2) [cite: 13, 39] ---
      - name: Despliegue y Orquestación vía SSH a EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }} # ¡CORREGIDO: ubuntu!
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            REMOTE_DIR="/home/${{ env.EC2_USER }}/michicode-app"
            
            # --- PREPARACIÓN EN EC2 ---
            
            # 1. Crear directorio de trabajo y asegurar que Docker Compose esté listo
            mkdir -p ${REMOTE_DIR}
            cd ${REMOTE_DIR}
            
            # 2. Copiar docker-compose.prod.yml y archivos de inicialización de la DB (init-mongo.js)
            # Usamos rsync para copiar archivos del runner a la EC2.
            # Nota: Necesitas que 'database/' esté disponible en el runner.
            echo "Copiando archivos de orquestación..."
            rsync -avz -e "ssh -i /dev/stdin -o StrictHostKeyChecking=no" \
              ./docker-compose.prod.yml ./database \
              ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${REMOTE_DIR}/
            
            # --- EJECUCIÓN DEL DESPLIEGUE ---
            
            # 3. Detener contenedores viejos y descargar imagen base de la DB
            docker compose down || true
            docker pull mongo:6
            
            # 4. Comando para hacer pull de las nuevas imágenes (usando el tag 'latest')
            docker pull ${{ env.DOCKER_IMAGE_BACKEND }}:latest
            docker pull ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
            
            # 5. Levantamos los contenedores con las variables de entorno de producción
            # Inyectamos los secretos del shell para que docker-compose.prod.yml pueda leerlos.
            echo "Ejecutando Docker Compose UP..."
            DOCKER_HUB_USERNAME="${{ secrets.DOCKER_HUB_USERNAME }}"
            EC2_HOST_DNS="${{ secrets.EC2_HOST_DNS }}"
            
            # [cite_start]Ejecución del comando de orquestación [cite: 13, 39]
            DOCKER_HUB_USERNAME=$DOCKER_HUB_USERNAME \
            EC2_HOST_DNS=$EC2_HOST_DNS \
            docker compose -f docker-compose.prod.yml up -d
            
            echo "¡DESPLIEGUE AUTOMÁTICO COMPLETADO! La aplicación debe estar disponible en http://${EC2_HOST_DNS}"